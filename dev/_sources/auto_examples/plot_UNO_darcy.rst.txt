
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/plot_UNO_darcy.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_examples_plot_UNO_darcy.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_plot_UNO_darcy.py:


Training a neural operator on Darcy-Flow
========================================
In this example, we demonstrate how to use the small Darcy-Flow example we ship with the package

.. GENERATED FROM PYTHON SOURCE LINES 9-23

.. code-block:: default



    import torch
    import matplotlib.pyplot as plt
    import sys
    from neuralop.models import TFNO, UNO
    from neuralop import Trainer
    from neuralop.datasets import load_darcy_flow_small
    from neuralop.utils import count_params
    from neuralop import LpLoss, H1Loss

    device = 'cpu'









.. GENERATED FROM PYTHON SOURCE LINES 24-25

Loading the Darcy Flow dataset

.. GENERATED FROM PYTHON SOURCE LINES 25-42

.. code-block:: default

    train_loader, test_loaders, output_encoder = load_darcy_flow_small(
            n_train=1000, batch_size=32, 
            test_resolutions=[16, 32], n_tests=[100, 50],
            test_batch_sizes=[32, 32],
    )



    model = UNO(3,1, hidden_channels=64, projection_channels=64,uno_out_channels = [32,64,64,64,32], uno_n_modes= [[16,16],[8,8],[8,8],[8,8],[16,16]], uno_scalings=  [[1.0,1.0],[0.5,0.5],[1,1],[2,2],[1,1]],\
                     horizontal_skips_map = None, n_layers = 5, domain_padding = 0.2)
    model = model.to(device)

    n_params = count_params(model)
    print(f'\nOur model has {n_params} parameters.')
    sys.stdout.flush()






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    UnitGaussianNormalizer init on 1000, reducing over [0, 1, 2, 3], samples of shape [1, 16, 16].
       Mean and std of shape torch.Size([1, 1, 1]), eps=1e-05
    Loading test db at resolution 32 with 50 samples and batch-size=32
    [32, 64, 64, 64, 32]

    Our model has 1787201 parameters.




.. GENERATED FROM PYTHON SOURCE LINES 43-44

Create the optimizer

.. GENERATED FROM PYTHON SOURCE LINES 44-50

.. code-block:: default

    optimizer = torch.optim.Adam(model.parameters(), 
                                    lr=8e-3, 
                                    weight_decay=1e-4)
    scheduler = torch.optim.lr_scheduler.CosineAnnealingLR(optimizer, T_max=30)









.. GENERATED FROM PYTHON SOURCE LINES 51-52

Creating the losses

.. GENERATED FROM PYTHON SOURCE LINES 52-59

.. code-block:: default

    l2loss = LpLoss(d=2, p=2)
    h1loss = H1Loss(d=2)

    train_loss = h1loss
    eval_losses={'h1': h1loss, 'l2': l2loss}









.. GENERATED FROM PYTHON SOURCE LINES 60-71

.. code-block:: default



    print('\n### MODEL ###\n', model)
    print('\n### OPTIMIZER ###\n', optimizer)
    print('\n### SCHEDULER ###\n', scheduler)
    print('\n### LOSSES ###')
    print(f'\n * Train: {train_loss}')
    print(f'\n * Test: {eval_losses}')
    sys.stdout.flush()






.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    ### MODEL ###
     UNO(
      (domain_padding): DomainPadding()
      (lifting): Lifting(
        (fc): Conv2d(3, 64, kernel_size=(1, 1), stride=(1, 1))
      )
      (fno_blocks): ModuleList(
        (0): FNOBlocks(
          (convs): FactorizedSpectralConv(
            (weight): ModuleList(
              (0-1): 2 x ComplexTuckerTensor(shape=(64, 32, 8, 8), rank=(63, 32, 8, 8))
            )
          )
          (fno_skips): ModuleList(
            (0): Conv2d(64, 32, kernel_size=(1, 1), stride=(1, 1), bias=False)
          )
        )
        (1): FNOBlocks(
          (convs): FactorizedSpectralConv(
            (weight): ModuleList(
              (0-1): 2 x ComplexTuckerTensor(shape=(32, 64, 4, 4), rank=(31, 61, 4, 4))
            )
          )
          (fno_skips): ModuleList(
            (0): Conv2d(32, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
          )
        )
        (2-3): 2 x FNOBlocks(
          (convs): FactorizedSpectralConv(
            (weight): ModuleList(
              (0-1): 2 x ComplexTuckerTensor(shape=(64, 64, 4, 4), rank=(62, 62, 4, 4))
            )
          )
          (fno_skips): ModuleList(
            (0): Conv2d(64, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
          )
        )
        (4): FNOBlocks(
          (convs): FactorizedSpectralConv(
            (weight): ModuleList(
              (0-1): 2 x ComplexTuckerTensor(shape=(64, 32, 8, 8), rank=(63, 32, 8, 8))
            )
          )
          (fno_skips): ModuleList(
            (0): Conv2d(64, 32, kernel_size=(1, 1), stride=(1, 1), bias=False)
          )
        )
      )
      (horizontal_skips): ModuleDict()
      (projection): Projection(
        (fc1): Conv2d(32, 64, kernel_size=(1, 1), stride=(1, 1))
        (fc2): Conv2d(64, 1, kernel_size=(1, 1), stride=(1, 1))
      )
    )

    ### OPTIMIZER ###
     Adam (
    Parameter Group 0
        amsgrad: False
        betas: (0.9, 0.999)
        capturable: False
        differentiable: False
        eps: 1e-08
        foreach: None
        fused: None
        initial_lr: 0.008
        lr: 0.008
        maximize: False
        weight_decay: 0.0001
    )

    ### SCHEDULER ###
     <torch.optim.lr_scheduler.CosineAnnealingLR object at 0x7f429d1aa220>

    ### LOSSES ###

     * Train: <neuralop.training.losses.H1Loss object at 0x7f429d210550>

     * Test: {'h1': <neuralop.training.losses.H1Loss object at 0x7f429d210550>, 'l2': <neuralop.training.losses.LpLoss object at 0x7f429d1aa370>}




.. GENERATED FROM PYTHON SOURCE LINES 72-73

Create the trainer

.. GENERATED FROM PYTHON SOURCE LINES 73-82

.. code-block:: default

    trainer = Trainer(model, n_epochs=20,
                      device=device,
                      mg_patching_levels=0,
                      wandb_log=False,
                      log_test_interval=3,
                      use_distributed=False,
                      verbose=True)






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Training on regular inputs (no multi-grid patching).




.. GENERATED FROM PYTHON SOURCE LINES 83-84

Actually train the model on our small Darcy-Flow dataset

.. GENERATED FROM PYTHON SOURCE LINES 84-95

.. code-block:: default


    trainer.train(train_loader, test_loaders,
                  output_encoder,
                  model, 
                  optimizer,
                  scheduler, 
                  regularizer=False, 
                  training_loss=train_loss,
                  eval_losses=eval_losses)






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Training on 1000 samples
    Testing on [50, 50] samples         on resolutions [16, 32].
    Training on raw inputs of size x.shape=torch.Size([32, 3, 16, 16]), y.shape=torch.Size([32, 1, 16, 16])
    .. patched inputs of size x.shape=torch.Size([32, 3, 16, 16]), y.shape=torch.Size([32, 1, 16, 16])
    Padding inputs of resolution=torch.Size([16, 16]) with padding=[3], one-sided
    Raw outputs of size out.shape=torch.Size([32, 1, 16, 16])
    .. Processed (unpatched) outputs of size out.shape=torch.Size([32, 1, 16, 16])
    Padding inputs of resolution=torch.Size([32, 32]) with padding=[6], one-sided
    [0] time=6.66, avg_loss=28.9498, train_err=0.5790, 16_h1=0.3994, 16_l2=0.3032, 32_h1=0.7292, 32_l2=0.3479
    [3] time=6.43, avg_loss=12.1916, train_err=0.2438, 16_h1=0.2398, 16_l2=0.1774, 32_h1=0.6117, 32_l2=0.2619
    [6] time=6.53, avg_loss=10.1477, train_err=0.2030, 16_h1=0.1847, 16_l2=0.1327, 32_h1=0.5323, 32_l2=0.2243
    [9] time=6.80, avg_loss=8.9046, train_err=0.1781, 16_h1=0.2129, 16_l2=0.1629, 32_h1=0.5527, 32_l2=0.2652
    [12] time=7.21, avg_loss=7.8623, train_err=0.1572, 16_h1=0.1579, 16_l2=0.1111, 32_h1=0.4337, 32_l2=0.1844
    [15] time=6.27, avg_loss=7.0154, train_err=0.1403, 16_h1=0.1483, 16_l2=0.0998, 32_h1=0.4228, 32_l2=0.1733
    [18] time=6.60, avg_loss=6.5928, train_err=0.1319, 16_h1=0.1362, 16_l2=0.0884, 32_h1=0.4342, 32_l2=0.1797




.. GENERATED FROM PYTHON SOURCE LINES 96-106

Plot the prediction, and compare with the ground-truth 
Note that we trained on a very small resolution for
a very small number of epochs
In practice, we would train at larger resolution, on many more samples.

However, for practicity, we created a minimal example that
i) fits in just a few Mb of memory
ii) can be trained quickly on CPU

In practice we would train a Neural Operator on one or multiple GPUs

.. GENERATED FROM PYTHON SOURCE LINES 106-143

.. code-block:: default


    test_samples = test_loaders[32].dataset

    fig = plt.figure(figsize=(7, 7))
    for index in range(3):
        data = test_samples[index]
        # Input x
        x = data['x']
        # Ground-truth
        y = data['y']
        # Model prediction
        out = model(x.unsqueeze(0))

        ax = fig.add_subplot(3, 3, index*3 + 1)
        ax.imshow(x[0], cmap='gray')
        if index == 0: 
            ax.set_title('Input x')
        plt.xticks([], [])
        plt.yticks([], [])

        ax = fig.add_subplot(3, 3, index*3 + 2)
        ax.imshow(y.squeeze())
        if index == 0: 
            ax.set_title('Ground-truth y')
        plt.xticks([], [])
        plt.yticks([], [])

        ax = fig.add_subplot(3, 3, index*3 + 3)
        ax.imshow(out.squeeze().detach().numpy())
        if index == 0: 
            ax.set_title('Model prediction')
        plt.xticks([], [])
        plt.yticks([], [])

    fig.suptitle('Inputs, ground-truth output and prediction.', y=0.98)
    plt.tight_layout()
    fig.show()



.. image-sg:: /auto_examples/images/sphx_glr_plot_UNO_darcy_001.png
   :alt: Inputs, ground-truth output and prediction., Input x, Ground-truth y, Model prediction
   :srcset: /auto_examples/images/sphx_glr_plot_UNO_darcy_001.png
   :class: sphx-glr-single-img






.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 2 minutes  16.464 seconds)


.. _sphx_glr_download_auto_examples_plot_UNO_darcy.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example




    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_UNO_darcy.py <plot_UNO_darcy.py>`

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_UNO_darcy.ipynb <plot_UNO_darcy.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
